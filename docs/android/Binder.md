---
typora-copy-images-to: ..\..\image
---

# Binder

### Binder是什么？

- 从机制、模型角度来说

  Binder是一种 Android 实现 **跨进程通信**（IPC）的方式。即**Binder机制模型**

  作用：在Android中实现跨进程通信

- 从模型的结构、组成来说

  Binder是一种虚拟的物理设备驱动。即**Binder驱动**

  作用：连接Service进程、Client进程和Service Manager进程

- 从Android代码实现的角度来说

  Binder是一个类，实现了IBinder接口。即**Binder类**

  作用：将Binder机制模型以代码的形式，具体实现在Android中

### Linux相关

#### 进程空间划分

一个进程空间划分为用户空间 & 内核空间，即把进程内用户&内核隔离开来

用户空间 不可共享，直接传输数据

内核空间 所有进程共享，可传输数据

二者区别

1. 进程间，用户空间的数据不可共享，所以用户空间=不可共享空间
2. 进程间，内核空间的数据可共享，所以内核空间=可共享空间

进程内，用户空间&内核空间进行交互需通过**系统调用**，主要通过函数

1. copy_from_user() 将用户空间的数据Copy到内核空间
2. copy_to_user()  将内核空间的数据Copy到用户空间

#### 进程隔离 & 跨进程通信（IPC）

- 进程隔离

  Android的进程是相互独立、隔离的。一个进程不能直接操作或者访问另一个进程

- 跨进程通信（IPC）

  进程间需要进行数据交互、通信

- 跨进程通信的基本原理
  1. 发送进程 通过系统调用，将需要发送的数据copy到Linux进程的内核空间中的缓存区中
  2. 内核服务程序 唤醒接收进程的接受线程，通过系统调用将数据发送到接收进程的用户空间中，最终完成数据发送。

缺点：

1. 效率低下，要做两次数据copy = 用户空间 ---> 内核空间 ---> 用户空间

2. 接受数据的缓存需要接收方提供，但接收方不知道要多大的缓存才可以满足需求

   （开辟尽量大的空间 | 先调用API接受消息头获取信息体大小） 空间 | 时间

Binder 的作用则是：连接两个进程，实现了mmap()系统调用，主要负责创建数据接收的缓存空间 & 管理数据接收缓存

Binder机制只需copy一次数据，不同于传统的跨进程通信方式，主要是使用了**内存映射**。

### Binder跨进程通信机制 模型

#### 模型原理图

`Binder` 跨进程通信机制模型基于 `client - server` 模式

![image-20201208142722637](D:%5Cternence%5CLearn-Notes%5Cimage%5CBinder.png)

#### 模型角色组成

| 角色                | 作用                                                         | 备注                                                         |
| ------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| Client 进程         | 使用服务的进程                                               | Android客户端                                                |
| Server 进程         | 提供服务的进程                                               | 服务器端                                                     |
| ServiceManager 进程 | 管理Service注册与查询（将字符形式的Binder名字 转换为Client中对该Binder的引用） | 类似于路由器                                                 |
| Binder 驱动         | 一种虚拟设备驱动，是连接Service进程、Client进程和Service Manager的桥梁，具体作用为：1.传递服务进程消息；2.传递进程间需传递的数据：通过内存映射；3.实现线程控制：采用Binder的线程池，并由Binder驱动自身进行管理。 | Binder驱动持有每个Server进程在内核控件中的Binder实体，并给Client进程提供Binder实体的引用 |

#### Binder驱动